stages:
  - test
  - build
  - package
  - e2e
  - cleanup

test:
  stage: test
  image: python:3.9.13-alpine3.15
  script:
    - pip install pipenv
    - pipenv install --dev
    - pipenv run coverage run -m pytest --junitxml=report.xml tests
    - pipenv run coverage report
    - pipenv run coverage xml
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  artifacts:
    reports:
      junit: report.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml

build:
  stage: build
  image: python:3.9.13-alpine3.15
  script:
    - pip install pipenv
    - pipenv install --dev
    - pipenv run python3 -m build
  artifacts:
    paths:
      - dist
    expire_in: 1 hour

containerize:
  stage: package
  image: docker:20.10.15-dind
  before_script:
    - docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD} ${CI_REGISTRY}
  script:
    - docker-compose build # -t ${CI_REGISTRY_IMAGE}/connect-four:${CI_COMMIT_SHORT_SHA}
    - docker-compose push #${CI_REGISTRY_IMAGE}/connect-four:latest #${CI_COMMIT_SHORT_SHA}
  after_script:
    - docker rmi ${CI_REGISTRY_IMAGE}/connect-four:latest # ${CI_REGISTRY_IMAGE}/connect-four:${CI_COMMIT_SHORT_SHA}

e2e-test:
  stage: e2e
  image: docker:20.10.15-dind
  variables:
    CONTAINER_IMAGE: ${CI_REGISTRY_IMAGE}/connect-four:latest # ${CI_REGISTRY_IMAGE}/connect-four:${CI_COMMIT_SHORT_SHA}
  before_script:
    - docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD} ${CI_REGISTRY}
  script:
    - apk add --update python3
    - python3 -m ensurepip
    - pip3 install pipenv
    - pipenv install --dev
    - pipenv run behave
  after_script:
    - docker rmi ${CI_REGISTRY_IMAGE}/connect-four:latest # ${CI_REGISTRY_IMAGE}/connect-four:${CI_COMMIT_SHORT_SHA}

remove-container:
  stage: cleanup
  image: docker:20.10.15-dind
  before_script:
    - docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD} ${CI_REGISTRY}
  script:
    - wget -O /usr/bin/reg https://github.com/genuinetools/reg/releases/download/v0.16.0/reg-linux-amd64
    - chmod +x /usr/bin/reg
    - reg rm ${CI_REGISTRY_IMAGE}/connect-four:latest # ${CI_REGISTRY_IMAGE}/connect-four:${CI_COMMIT_SHORT_SHA}
  except:
    variables:
      - $CI_COMMIT_TAG


